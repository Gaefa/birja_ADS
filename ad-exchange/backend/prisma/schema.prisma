// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int     @id @default(autoincrement())
  email     String  @unique
  password  String
  /// UserRole: BLOGGER | ISSUER | ADMIN
  role      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bloggerProfile BloggerProfile?
  issuerProfile  IssuerProfile?
  disputesResolved Dispute[] @relation("resolvedDisputies")
  transactions   Transaction[]
}

model BloggerProfile {
  id              Int     @id @default(autoincrement())
  userId          Int     @unique
  displayName     String
  avatar          String?
  bio             String?
  niche           String?
  geoCountry      String?
  telegramContact String?
  isActive        Boolean @default(true)
  rating          Float   @default(0)
  totalDeals      Int     @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccounts    SocialAccount[]
  priceListItems    PriceListItem[]
  portfolioItems    PortfolioItem[]
  campaignApplies   CampaignApplication[]
  deals             Deal[] @relation("bloggerDeals")
  reviews           Review[] @relation("bloggerReviews")
  commissionSetting CommissionSetting?
  exclusiveServices ExclusiveService[]
}

model SocialAccount {
  id              Int     @id @default(autoincrement())
  bloggerId       Int
  /// SocialPlatform: TELEGRAM | YOUTUBE | INSTAGRAM | TIKTOK | TWITTER | VK
  platform        String
  username        String
  url             String?
  followersCount  Int?
  avgViews        Int?
  engagementRate  Float?
  isVerified      Boolean @default(false)
  verifiedAt      DateTime?
  createdAt       DateTime @default(now())

  blogger         BloggerProfile @relation(fields: [bloggerId], references: [id], onDelete: Cascade)

  @@unique([bloggerId, platform])
}

model PriceListItem {
  id              Int             @id @default(autoincrement())
  bloggerId       Int
  formatName      String
  description     String?
  priceRub        Decimal?
  priceUsd        Decimal?
  priceUsdt       Decimal?
  durationDays    Int?
  isAvailable     Boolean         @default(true)
  /// SocialPlatform or null (universal / all platforms)
  platform        String?
  /// Спецпроект — price negotiated individually, priceRub = 0
  isSpecialProject Boolean        @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  blogger         BloggerProfile  @relation(fields: [bloggerId], references: [id], onDelete: Cascade)
}

model PortfolioItem {
  id          Int     @id @default(autoincrement())
  bloggerId   Int
  title       String
  description String?
  imageUrl    String?
  postUrl     String?
  category    String?
  createdAt   DateTime @default(now())

  blogger     BloggerProfile @relation(fields: [bloggerId], references: [id], onDelete: Cascade)
}

model IssuerProfile {
  id                  Int     @id @default(autoincrement())
  userId              Int     @unique
  companyName         String
  logo                String?
  description         String?
  /// CompanyType: BROKER | CRYPTO_EXCHANGE | DEFI | FUND | OTHER
  companyType         String
  website             String?
  isVerified          Boolean @default(false)
  verifiedAt          DateTime?
  /// SubscriptionTier: BASE | PRO
  subscriptionTier    String @default("BASE")
  subscriptionExpiresAt DateTime?
  rating              Float   @default(0)
  totalDeals          Int     @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaigns Campaign[]
  deals     Deal[]
  reviews   Review[] @relation("issuerReviews")
  disputes  Dispute[] @relation("issuerDisputes")
}

model Campaign {
  id              Int     @id @default(autoincrement())
  issuerId        Int
  title           String
  description     String?
  brief           String?
  budgetPerBlogger Decimal
  /// CurrencyType: RUB | USD | USDT
  currency        String
  bloggersNeeded  Int
  deadline        DateTime
  /// CampaignStatus: DRAFT | ACTIVE | PAUSED | COMPLETED | CANCELLED
  status          String @default("DRAFT")
  isPrivate       Boolean @default(false)
  platforms       String @default("[]")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  issuer          IssuerProfile @relation(fields: [issuerId], references: [id], onDelete: Cascade)
  applications    CampaignApplication[]
  deals           Deal[] @relation("campaignDeals")
}

model CampaignApplication {
  id          Int     @id @default(autoincrement())
  campaignId  Int
  bloggerId   Int
  pitch       String?
  proposedPrice Decimal
  /// ApplicationStatus: PENDING | ACCEPTED | REJECTED
  status      String @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  blogger     BloggerProfile @relation(fields: [bloggerId], references: [id], onDelete: Cascade)
  deal        Deal?

  @@unique([campaignId, bloggerId])
}

model Deal {
  id                      Int             @id @default(autoincrement())
  campaignApplicationId   Int?            @unique
  campaignId              Int?
  issuerId                Int
  bloggerId               Int
  title                   String
  brief                   String?
  /// Full TZ (technical specification) provided by issuer
  tz                      String?
  /// SocialPlatform or null
  socialPlatform          String?
  /// Name of the placement format (from blogger's price list)
  formatName              String?
  amount                  Decimal
  /// CurrencyType: RUB | USD | USDT
  currency                String
  platformCommission      Decimal         @default(0)
  bloggerAmount           Decimal
  /// DealStatus: CREATED | ESCROW_FUNDED | CONTENT_SUBMITTED | COMPLETED | DISPUTED | REFUNDED | CANCELLED
  status                  String          @default("CREATED")
  contentUrl              String?
  contentSubmittedAt      DateTime?
  completedAt             DateTime?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  campaignApplication     CampaignApplication? @relation(fields: [campaignApplicationId], references: [id], onDelete: SetNull)
  campaign                Campaign? @relation("campaignDeals", fields: [campaignId], references: [id], onDelete: SetNull)
  issuer                  IssuerProfile @relation(fields: [issuerId], references: [id], onDelete: Cascade)
  blogger                 BloggerProfile @relation("bloggerDeals", fields: [bloggerId], references: [id], onDelete: Cascade)
  dispute                 Dispute?
  reviews                 Review[]
  transactions            Transaction[]
}

model Dispute {
  id          Int     @id @default(autoincrement())
  dealId      Int     @unique
  issuerId    Int?
  /// DisputeOpener: ISSUER | BLOGGER
  openedBy    String
  reason      String
  description String?
  /// DisputeStatus: OPEN | UNDER_REVIEW | RESOLVED
  status      String @default("OPEN")
  resolution  String?
  resolvedBy  Int?
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())

  deal        Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  admin       User? @relation("resolvedDisputies", fields: [resolvedBy], references: [id], onDelete: SetNull)
  issuer      IssuerProfile? @relation("issuerDisputes", fields: [issuerId], references: [id], onDelete: SetNull)
}

model Review {
  id          Int     @id @default(autoincrement())
  dealId      Int
  /// ReviewAuthor: ISSUER | BLOGGER
  authorRole  String
  issuerId    Int?
  bloggerId   Int?
  rating      Int
  comment     String?
  createdAt   DateTime @default(now())

  deal        Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  issuer      IssuerProfile? @relation("issuerReviews", fields: [issuerId], references: [id], onDelete: SetNull)
  blogger     BloggerProfile? @relation("bloggerReviews", fields: [bloggerId], references: [id], onDelete: SetNull)
}

model Transaction {
  id          Int     @id @default(autoincrement())
  dealId      Int
  userId      Int
  /// TransactionType: ESCROW_DEPOSIT | PLATFORM_FEE | BLOGGER_PAYOUT | REFUND
  type        String
  amount      Decimal
  /// CurrencyType: RUB | USD | USDT
  currency    String
  /// TransactionStatus: PENDING | COMPLETED | FAILED
  status      String @default("PENDING")
  createdAt   DateTime @default(now())

  deal        Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// Platform-level commission configuration (admin-managed)
model CommissionSetting {
  id          Int      @id @default(autoincrement())
  /// null = global rate; set to bloggerId for per-blogger override
  bloggerId   Int?     @unique
  /// null for global+blogger; set to priceListItemId for per-service override
  priceItemId Int?     @unique
  /// Commission rate as decimal, e.g. 0.10 = 10%
  rate        Decimal
  updatedAt   DateTime @updatedAt
  updatedBy   Int?

  blogger     BloggerProfile? @relation(fields: [bloggerId], references: [id], onDelete: Cascade)
}

/// Exclusive services available only through this platform
model ExclusiveService {
  id          Int             @id @default(autoincrement())
  key         String          @unique
  name        String
  description String?
  priceRub    Decimal         @default(0)
  commRate    Decimal         @default(0.10)
  /// Optional: linked to a specific blogger
  bloggerId   Int?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  blogger     BloggerProfile? @relation(fields: [bloggerId], references: [id], onDelete: SetNull)
}
